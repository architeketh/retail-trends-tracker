<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Retail Trends Tracker â€” Charts</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    header{text-align:center;color:#fff;margin-bottom:24px}
    h1{font-size:2.2em;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.2)}
    .controls{background:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,.08);display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:16px}
    button{background:#667eea;color:#fff;border:none;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer}
    button:hover{background:#5568d3}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    .section{background:#fff;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,.08);padding:18px;margin-bottom:16px}
    .section h2{border-bottom:3px solid #667eea;padding-bottom:6px;margin-bottom:12px}
    .articles{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
    .card{background:#f9f9f9;border-left:4px solid #667eea;border-radius:10px;padding:12px}
    .card.new{border-left-color:#22c55e;background:#f0fff4}
    .meta{display:flex;justify-content:space-between;font-size:12px;color:#667eea;font-weight:800;text-transform:uppercase;margin-bottom:6px}
    .time{color:#888;font-weight:500}
    .title{font-weight:800;margin:4px 0;color:#222}
    .excerpt{font-size:14px;color:#555;margin:6px 0}
    .pill{display:inline-block;background:#22c55e;color:#fff;border-radius:999px;font-size:10px;font-weight:900;padding:2px 6px;margin-left:6px}
    summary{cursor:pointer;font-weight:800}
    .muted{color:#666}
    canvas{max-width:100%;height:340px !important}
    @media(max-width:1024px){.grid{grid-template-columns:1fr}}
    .taglist{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0}
    .tag{background:#e0e7ff;color:#667eea;border-radius:12px;padding:2px 8px;font-size:11px;font-weight:700}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“Š Retail Trends Tracker â€” Charts</h1>
      <p class="muted" style="color:#eef">Articles + Monthly Keyword & Brand charts (top 8, last 12 months)</p>
    </header>

    <div class="controls">
      <div>
        <button id="refresh">ðŸ”„ Reload data</button>
        <span id="status" class="muted">Ready</span>
      </div>
      <div class="muted">Data file: <code>/data/articles.json</code></div>
    </div>

    <div class="grid">
      <div>
        <div class="section">
          <h2>ðŸ“° Recent Articles</h2>
          <div id="articles" class="articles"></div>
        </div>
        <div class="section">
          <h2>ðŸ“¦ Archive</h2>
          <div id="archive"></div>
        </div>
      </div>
      <div>
        <div class="section">
          <h2>ðŸ“ˆ Monthly Keywords</h2>
          <canvas id="monthlyKeywordsChart"></canvas>
        </div>
        <div class="section">
          <h2>ðŸ“ˆ Monthly Brands</h2>
          <canvas id="monthlyBrandsChart"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
const DATA_URL = "./data/articles.json";
const NEW_WINDOW_MS = 2 * 60 * 60 * 1000;
const LS_KEY = "rtt_seen_ts_v1";

let seenTs = 0;
try { seenTs = parseInt(localStorage.getItem(LS_KEY) || "0", 10) || 0; } catch {}

function timeago(ts){
  const s = Math.floor((Date.now() - ts)/1000);
  if (s < 60) return s + "s ago";
  if (s < 3600) return Math.floor(s/60) + "m ago";
  if (s < 86400) return Math.floor(s/3600) + "h ago";
  return Math.floor(s/86400) + "d ago";
}

function groupByDate(items){
  const map = {};
  for (const a of items){
    const d = new Date(a.published || Date.now()).toISOString().slice(0,10);
    (map[d] = map[d] || []).push(a);
  }
  return Object.entries(map).sort((a,b)=> b[0].localeCompare(a[0]));
}

// ---- Charts helpers ----
function last12MonthLabels(){
  const now = new Date();
  const labels = [];
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    labels.push(d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
  }
  return labels;
}
function monthIndex(ts){
  const now = new Date();
  const dt = new Date(ts || Date.now());
  return (now.getFullYear() - dt.getFullYear()) * 12 + (now.getMonth() - dt.getMonth());
}
function countMonthly(items, field){
  const labelList = last12MonthLabels();
  const buckets = {}; // term -> [12]
  for (const a of items){
    if (!a[field] || !a.published) continue;
    const diff = monthIndex(a.published);
    const idx = 11 - diff;
    if (idx < 0 || idx > 11) continue;
    for (const t of a[field]){
      if (!buckets[t]) buckets[t] = Array(12).fill(0);
      buckets[t][idx] += 1;
    }
  }
  return { labels: labelList, buckets };
}
function topTerms(buckets, n=8){
  return Object.entries(buckets)
    .map(([name, arr]) => [name, arr.reduce((s,v)=>s+v,0)])
    .sort((a,b)=> b[1]-a[1])
    .slice(0, n)
    .map(([name]) => name);
}
function palette(k){
  const colors = ['#667eea','#764ba2','#f093fb','#4facfe','#43e97b','#fa709a','#30cfd0','#ffbe0b','#8338ec','#3a86ff','#06ffa5','#fb5607'];
  return colors[k % colors.length];
}
let __kwChart, __brChart;
function renderKeywordBrandCharts(items){
  const kw = countMonthly(items, "keywords");
  const br = countMonthly(items, "brands");
  const kwTerms = topTerms(kw.buckets, 8);
  const brTerms = topTerms(br.buckets, 8);

  const kwCtx = document.getElementById('monthlyKeywordsChart')?.getContext('2d');
  const brCtx = document.getElementById('monthlyBrandsChart')?.getContext('2d');
  if (!kwCtx || !brCtx) return;

  if (__kwChart) __kwChart.destroy();
  if (__brChart) __brChart.destroy();

  __kwChart = new Chart(kwCtx, {
    type: 'line',
    data: {
      labels: kw.labels,
      datasets: kwTerms.map((t,i)=>({
        label: t,
        data: kw.buckets[t],
        borderColor: palette(i),
        backgroundColor: palette(i) + '22',
        tension: .35,
        fill: false,
        borderWidth: 2
      }))
    },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
  });

  __brChart = new Chart(brCtx, {
    type: 'line',
    data: {
      labels: br.labels,
      datasets: brTerms.map((t,i)=>({
        label: t,
        data: br.buckets[t],
        borderColor: palette(i),
        backgroundColor: palette(i) + '22',
        tension: .35,
        fill: false,
        borderWidth: 2
      }))
    },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
  });
}

// ---- Render UI ----
function render(items){
  const now = Date.now();
  const cards = items.slice(0, 60).map(a => {
    const isNew = (a.published && a.published > seenTs && now - a.published < NEW_WINDOW_MS);
    return `<div class="card ${isNew ? "new": ""}">
      <div class="meta"><span>${a.source || "Source"}</span><span class="time">${timeago(a.published||Date.now())}</span></div>
      <div class="title">${a.title}${isNew? '<span class="pill">NEW</span>':''}</div>
      <div class="excerpt">${a.excerpt || ""}</div>
      <div class="taglist">${(a.keywords||[]).map(t=>`<span class="tag">${t}</span>`).join("")}
      ${(a.brands||[]).map(t=>`<span class="tag">${t}</span>`).join("")}</div>
      <a href="${a.link}" target="_blank" rel="noopener">Read â†’</a>
    </div>`;
  }).join("");
  document.getElementById("articles").innerHTML = cards || '<div class="muted">No articles.</div>';

  const grouped = groupByDate(items);
  const html = grouped.map(([day, list]) => {
    return `<details><summary>${day} â€” ${list.length} articles</summary>
      <ul style="margin:8px 0 0 18px">
        ${list.map(a => `<li><a href="${a.link}" target="_blank" rel="noopener">${a.title}</a></li>`).join("")}
      </ul>
    </details>`;
  }).join("");
  document.getElementById("archive").innerHTML = html || '<div class="muted">No archive yet.</div>';

  renderKeywordBrandCharts(items);
}

async function loadData(bust=false){
  document.getElementById("status").textContent = "Loadingâ€¦";
  const url = bust ? DATA_URL + "?t=" + Date.now() : DATA_URL;
  const res = await fetch(url);
  const data = await res.json();
  document.getElementById("status").textContent = "Updated " + new Date(data.generatedAt).toLocaleString();
  render(data.items || []);
}

document.getElementById("refresh").addEventListener("click", async () => {
  try{
    await loadData(true);
    localStorage.setItem(LS_KEY, String(Date.now()));
  }catch(e){
    document.getElementById("status").textContent = "Error: " + e.message;
  }
});

loadData().catch(e => document.getElementById("status").textContent = "Error: " + e.message);
</script>
</body>
</html>
