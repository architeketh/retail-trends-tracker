<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Retail Trends Tracker â€” Daily / Weekly / Monthly with Chips</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#667eea 0%, #764ba2 100%);min-height:100vh;padding:20px}
.container{max-width:1320px;margin:0 auto}
header{text-align:center;color:#fff;margin-bottom:22px}
h1{font-size:2.1em;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.2)}
a.btn{display:inline-block;background:#fff;color:#667eea;font-weight:800;text-decoration:none;padding:8px 12px;border-radius:10px;margin-top:8px}
.controls{background:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,.08);display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:16px}
button{background:#667eea;color:#fff;border:none;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer}
button:hover{background:#5568d3}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
.section{background:#fff;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,.08);padding:18px;margin-bottom:16px}
.section h2{border-bottom:3px solid #667eea;padding-bottom:6px;margin-bottom:12px}
.bucket{margin-bottom:12px}
.bucket h3{font-size:1.05rem;margin-bottom:8px;color:#333}
.articles{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
.card{background:#f9f9f9;border-left:4px solid #667eea;border-radius:10px;padding:12px}
.meta{display:flex;justify-content:space-between;font-size:12px;color:#667eea;font-weight:800;text-transform:uppercase;margin-bottom:6px}
.time{color:#888;font-weight:500}
.title{font-weight:800;margin:4px 0;color:#222}
.excerpt{font-size:14px;color:#555;margin:6px 0}
.taglist{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0}
.tag{background:#e0e7ff;color:#667eea;border-radius:12px;padding:2px 8px;font-size:11px;font-weight:700}
canvas{max-width:100%;height:300px !important}
.muted{color:#eee}
.byday details{background:#f9f9f9;border-radius:10px;padding:10px;margin-bottom:8px}
.byday summary{cursor:pointer;font-weight:800}
ul{margin:8px 0 0 18px}
li{margin:6px 0}
a.link{color:#667eea;text-decoration:none;font-weight:700}
a.link:hover{text-decoration:underline}
.charts{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:1100px){.charts{grid-template-columns:1fr 1fr}}
/* chip UI */
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 10px}
select{min-width:220px;padding:8px;border:2px solid #e0e0e0;border-radius:8px}
.btn-ghost{background:#e5e7eb;color:#333}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:6px;background:#667eea;color:#fff;border-radius:999px;font-size:12px;font-weight:800;padding:4px 10px;cursor:pointer}
.chip b{font-size:14px}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>
</head>
<body>
<div class="container">
  <header>
    <h1>ðŸ“Š Retail Trends Tracker</h1>
    <div class="muted">Grouped by day/week/month â€¢ Daily, Weekly & Monthly keyword/brand charts (with filters)</div>
    <a href="archive.html" class="btn">ðŸ“¦ Open Archive</a>
  </header>

  <div class="controls">
    <div>
      <button id="refresh">ðŸ”„ Reload data</button>
      <span id="status">Ready</span>
    </div>
    <div style="color:#667eea;font-weight:700">Data: <code>/data/articles.json</code></div>
  </div>

  <div class="grid">
    <div>
      <div class="section">
        <h2>ðŸ“° Articles by Time Period</h2>
        <div class="bucket"><h3>Today</h3><div id="list-today" class="articles"></div></div>
        <div class="bucket"><h3>This Week</h3><div id="list-week" class="articles"></div></div>
        <div class="bucket"><h3>This Month</h3><div id="list-month" class="articles"></div></div>
      </div>

      <div class="section">
        <h2>ðŸ“… Articles by Day</h2>
        <div id="byday" class="byday"></div>
      </div>
    </div>

    <div>
      <!-- Daily charts -->
      <div class="section">
        <h2>ðŸ“ˆ Daily Keywords (14 days)</h2>
        <div class="row">
          <select id="dkSelect"><option value="">+ Add keywordâ€¦</option></select>
          <button id="dkClear" class="btn-ghost">Clear</button>
          <div id="dkChips" class="chips"></div>
        </div>
        <canvas id="dailyKeywordsChart"></canvas>
      </div>

      <div class="section">
        <h2>ðŸ“ˆ Daily Brands (14 days)</h2>
        <div class="row">
          <select id="dbSelect"><option value="">+ Add brandâ€¦</option></select>
          <button id="dbClear" class="btn-ghost">Clear</button>
          <div id="dbChips" class="chips"></div>
        </div>
        <canvas id="dailyBrandsChart"></canvas>
      </div>

      <!-- Weekly charts -->
      <div class="section">
        <h2>ðŸ“ˆ Weekly Keywords (12 weeks)</h2>
        <div class="row">
          <select id="wkSelect"><option value="">+ Add keywordâ€¦</option></select>
          <button id="wkClear" class="btn-ghost">Clear</button>
          <div id="wkChips" class="chips"></div>
        </div>
        <canvas id="weeklyKeywordsChart"></canvas>
      </div>

      <div class="section">
        <h2>ðŸ“ˆ Weekly Brands (12 weeks)</h2>
        <div class="row">
          <select id="wbSelect"><option value="">+ Add brandâ€¦</option></select>
          <button id="wbClear" class="btn-ghost">Clear</button>
          <div id="wbChips" class="chips"></div>
        </div>
        <canvas id="weeklyBrandsChart"></canvas>
      </div>

      <!-- Monthly charts -->
      <div class="section">
        <h2>ðŸ“ˆ Monthly Keywords (12 months)</h2>
        <div class="row">
          <select id="mkSelect"><option value="">+ Add keywordâ€¦</option></select>
          <button id="mkClear" class="btn-ghost">Clear</button>
          <div id="mkChips" class="chips"></div>
        </div>
        <canvas id="monthlyKeywordsChart"></canvas>
      </div>

      <div class="section">
        <h2>ðŸ“ˆ Monthly Brands (12 months)</h2>
        <div class="row">
          <select id="mbSelect"><option value="">+ Add brandâ€¦</option></select>
          <button id="mbClear" class="btn-ghost">Clear</button>
          <div id="mbChips" class="chips"></div>
        </div>
        <canvas id="monthlyBrandsChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
// ---- Config ----
const DATA_URL = "./data/articles.json";
const KEYWORDS = ["ai","digital","ecommerce","supply chain","fulfillment","delivery","automation","customer experience","omnichannel","sustainability","personalization","mobile","analytics","inventory","logistics","payment","checkout","returns"];
const BRANDS   = ["Amazon","Walmart","Target","Home Depot","Costco","Kroger","CVS","Walgreens","Best Buy","Lowe's","Nike","Apple","Etsy","Wayfair","DoorDash"];

// ---- Utilities ----
function timeago(ts){ const s=Math.floor((Date.now()-ts)/1000);
  if(s<60) return s+"s ago"; if(s<3600) return Math.floor(s/60)+"m ago";
  if(s<86400) return Math.floor(s/3600)+"h ago"; return Math.floor(s/86400)+"d ago";
}
function startOfToday(){ const d=new Date(); d.setHours(0,0,0,0); return d.getTime(); }
function startOfWeek(){ const d=new Date(); d.setHours(0,0,0,0); const dow=d.getDay(); d.setDate(d.getDate()-dow); return d.getTime(); }
function startOfMonth(){ const d=new Date(); d.setHours(0,0,0,0); d.setDate(1); return d.getTime(); }

function renderCards(id, items){
  const html = items.slice(0, 40).map(a=>`
    <div class="card">
      <div class="meta"><span>${a.source||'Source'}</span><span class="time">${timeago(a.published||Date.now())}</span></div>
      <div class="title">${a.title}</div>
      <div class="excerpt">${a.excerpt||''}</div>
      <div class="taglist">
        ${(a.keywords||[]).map(t=>`<span class="tag">${t}</span>`).join('')}
        ${(a.brands||[]).map(t=>`<span class="tag">${t}</span>`).join('')}
      </div>
      <a class="link" href="${a.link}" target="_blank" rel="noopener">Read â†’</a>
    </div>`).join("");
  document.getElementById(id).innerHTML = html || '<div class="muted">No articles</div>';
}

function groupByDay(items){
  const map={};
  for(const a of items){
    const d=new Date(a.published||Date.now()).toISOString().slice(0,10);
    (map[d]=map[d]||[]).push(a);
  }
  return Object.entries(map).sort((a,b)=> b[0].localeCompare(a[0]));
}
function renderByDay(items){
  const groups = groupByDay(items);
  const html = groups.map(([day,list])=>`
    <details>
      <summary>${day} â€” ${list.length} articles</summary>
      <ul>${list.map(a=>`<li><a class="link" href="${a.link}" target="_blank" rel="noopener">${a.title}</a> <small style="color:#667eea">Â· ${a.source||'Source'}</small></li>`).join("")}</ul>
    </details>
  `).join("");
  document.getElementById('byday').innerHTML = html || '<div class="muted">No items.</div>';
}

// ---- Client-side tagging fallback ----
function tagText(title, excerpt, list){
  const text = `${title} ${excerpt}`.toLowerCase();
  const out = [];
  for(const term of list){
    const esc = term.replace(/[.*+?^${}()|[\\]\\]/g, "\\$&");
    const re = new RegExp(`\\b${esc}\\b`, "i");
    if(re.test(text)) out.push(term);
  }
  return out;
}
function ensureTags(items){
  for(const a of items){
    if(!a.keywords) a.keywords = tagText(a.title||"", a.excerpt||"", KEYWORDS);
    if(!a.brands)   a.brands   = tagText(a.title||"", a.excerpt||"", BRANDS);
  }
  return items;
}

// ---- Time axes ----
function lastNDays(n){
  const out=[]; const d=new Date(); d.setHours(0,0,0,0);
  for(let i=n-1;i>=0;i--){ const x=new Date(d); x.setDate(d.getDate()-i); out.push(x.toISOString().slice(0,10)); }
  return out;
}
function isoWeek(d){
  const dt = new Date(d.getTime()); dt.setHours(0,0,0,0);
  dt.setDate(dt.getDate() + 3 - ((dt.getDay()+6)%7));
  const week1 = new Date(dt.getFullYear(),0,4);
  const week = 1 + Math.round(((dt - week1)/86400000 - 3 + ((week1.getDay()+6)%7)) / 7);
  return `${dt.getFullYear()}-W${String(week).padStart(2,"0")}`;
}
function lastNWeeks(n){
  const out=[]; const today=new Date(); today.setHours(0,0,0,0);
  for(let i=n-1;i>=0;i--){ const d=new Date(today); d.setDate(today.getDate()-i*7); out.push(isoWeek(d)); }
  return out.filter((v,i,a)=>a.indexOf(v)===i);
}
function last12MonthLabels(){
  const now = new Date();
  const labels = [];
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    labels.push(d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
  }
  return labels;
}

// ---- Bucketing ----
function bucketDailyTerms(items, field, ndays=14){
  const labels = lastNDays(ndays);
  const pos = new Map(labels.map((d,i)=>[d,i]));
  const buckets = {};
  for(const a of items){
    if(!a.published) continue;
    const day = new Date(a.published).toISOString().slice(0,10);
    const idx = pos.get(day);
    if(idx===undefined) continue;
    for(const t of (a[field]||[])){
      (buckets[t] ||= Array(ndays).fill(0))[idx] += 1;
    }
  }
  return { labels, buckets };
}
function bucketWeeklyTerms(items, field, nweeks=12){
  const labels = lastNWeeks(nweeks);
  const pos = new Map(labels.map((w,i)=>[w,i]));
  const buckets = {};
  for(const a of items){
    if(!a.published) continue;
    const w = isoWeek(new Date(a.published));
    const idx = pos.get(w);
    if(idx===undefined) continue;
    for(const t of (a[field]||[])){
      (buckets[t] ||= Array(labels.length).fill(0))[idx] += 1;
    }
  }
  return { labels, buckets };
}
function bucketMonthlyTerms(items, field){
  const labels = last12MonthLabels();
  const keys = [];
  const now = new Date();
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    keys.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);
  }
  const pos = new Map(keys.map((k,i)=>[k,i]));
  const buckets = {};
  for (const a of items){
    if (!a.published) continue;
    const d = new Date(a.published);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const idx = pos.get(key);
    if (idx === undefined) continue;
    for (const t of (a[field]||[])){
      (buckets[t] ||= Array(labels.length).fill(0))[idx] += 1;
    }
  }
  return { labels, buckets };
}

function topTerms(buckets, n=8){
  return Object.entries(buckets).map(([k,arr])=>[k,arr.reduce((s,v)=>s+v,0)])
    .sort((a,b)=>b[1]-a[1]).slice(0,n).map(([k])=>k);
}
function palette(k){ const c=['#667eea','#764ba2','#f093fb','#4facfe','#43e97b','#fa709a','#30cfd0','#ffbe0b','#8338ec','#3a86ff','#06ffa5','#fb5607']; return c[k % c.length]; }

// ---- Filter state ----
let DK_SELECTED=[], DB_SELECTED=[], WK_SELECTED=[], WB_SELECTED=[], MK_SELECTED=[], MB_SELECTED=[];
let KW_ALL=[], BR_ALL=[];

function chip(label){ return `<span class="chip" data-v="${label}">${label} <b>Ã—</b></span>`; }
function updateChipBar(kind){
  const map = {
    dk: ['dkChips', ()=>DK_SELECTED, v=>DK_SELECTED=DK_SELECTED.filter(x=>x!==v)],
    db: ['dbChips', ()=>DB_SELECTED, v=>DB_SELECTED=DB_SELECTED.filter(x=>x!==v)],
    wk: ['wkChips', ()=>WK_SELECTED, v=>WK_SELECTED=WK_SELECTED.filter(x=>x!==v)],
    wb: ['wbChips', ()=>WB_SELECTED, v=>WB_SELECTED=WB_SELECTED.filter(x=>x!==v)],
    mk: ['mkChips', ()=>MK_SELECTED, v=>MK_SELECTED=MK_SELECTED.filter(x=>x!==v)],
    mb: ['mbChips', ()=>MB_SELECTED, v=>MB_SELECTED=MB_SELECTED.filter(x=>x!==v)]
  };
  const [id, get, remove] = map[kind];
  const el = document.getElementById(id);
  el.innerHTML = get().map(chip).join('');
  [...el.querySelectorAll('.chip')].forEach(s=>{
    s.onclick = ()=>{
      const v = s.getAttribute('data-v');
      remove(v);
      updateChipBar(kind);
      renderAllCharts(window.__ALL_ITEMS||[]);
    };
  });
}
function populateSelects(items){
  const kwSet=new Set(), brSet=new Set();
  for(const a of items){
    (a.keywords||[]).forEach(k=>kwSet.add(k));
    (a.brands||[]).forEach(b=>brSet.add(b));
  }
  KW_ALL = Array.from(kwSet).sort((a,b)=>a.localeCompare(b));
  BR_ALL = Array.from(brSet).sort((a,b)=>a.localeCompare(b));

  const sel = (id,list)=>{ const el=document.getElementById(id); el.innerHTML = `<option value="">+ Addâ€¦</option>`+list.map(x=>`<option>${x}</option>`).join(''); return el; };

  const dkSel=sel('dkSelect',KW_ALL), dbSel=sel('dbSelect',BR_ALL),
        wkSel=sel('wkSelect',KW_ALL), wbSel=sel('wbSelect',BR_ALL),
        mkSel=sel('mkSelect',KW_ALL), mbSel=sel('mbSelect',BR_ALL);

  dkSel.onchange = ()=>{ const v=dkSel.value; if(v && !DK_SELECTED.includes(v)){ DK_SELECTED.push(v); updateChipBar('dk'); renderAllCharts(window.__ALL_ITEMS||[]);} dkSel.value=""; };
  dbSel.onchange = ()=>{ const v=dbSel.value; if(v && !DB_SELECTED.includes(v)){ DB_SELECTED.push(v); updateChipBar('db'); renderAllCharts(window.__ALL_ITEMS||[]);} dbSel.value=""; };
  wkSel.onchange = ()=>{ const v=wkSel.value; if(v && !WK_SELECTED.includes(v)){ WK_SELECTED.push(v); updateChipBar('wk'); renderAllCharts(window.__ALL_ITEMS||[]);} wkSel.value=""; };
  wbSel.onchange = ()=>{ const v=wbSel.value; if(v && !WB_SELECTED.includes(v)){ WB_SELECTED.push(v); updateChipBar('wb'); renderAllCharts(window.__ALL_ITEMS||[]);} wbSel.value=""; };
  mkSel.onchange = ()=>{ const v=mkSel.value; if(v && !MK_SELECTED.includes(v)){ MK_SELECTED.push(v); updateChipBar('mk'); renderAllCharts(window.__ALL_ITEMS||[]);} mkSel.value=""; };
  mbSel.onchange = ()=>{ const v=mbSel.value; if(v && !MB_SELECTED.includes(v)){ MB_SELECTED.push(v); updateChipBar('mb'); renderAllCharts(window.__ALL_ITEMS||[]);} mbSel.value=""; };

  document.getElementById('dkClear').onclick=()=>{ DK_SELECTED=[]; updateChipBar('dk'); renderAllCharts(window.__ALL_ITEMS||[]); };
  document.getElementById('dbClear').onclick=()=>{ DB_SELECTED=[]; updateChipBar('db'); renderAllCharts(window.__ALL_ITEMS||[]); };
  document.getElementById('wkClear').onclick=()=>{ WK_SELECTED=[]; updateChipBar('wk'); renderAllCharts(window.__ALL_ITEMS||[]); };
  document.getElementById('wbClear').onclick=()=>{ WB_SELECTED=[]; updateChipBar('wb'); renderAllCharts(window.__ALL_ITEMS||[]); };
  document.getElementById('mkClear').onclick=()=>{ MK_SELECTED=[]; updateChipBar('mk'); renderAllCharts(window.__ALL_ITEMS||[]); };
  document.getElementById('mbClear').onclick=()=>{ MB_SELECTED=[]; updateChipBar('mb'); renderAllCharts(window.__ALL_ITEMS||[]); };

  updateChipBar('dk'); updateChipBar('db'); updateChipBar('wk'); updateChipBar('wb'); updateChipBar('mk'); updateChipBar('mb');
}

// ---- Charts ----
let chDKW, chDBR, chWKW, chWBR, chMKW, chMBR;
function drawLine(id, labels, series){
  const ctx=document.getElementById(id).getContext('2d');
  return new Chart(ctx,{type:'line',data:{labels,datasets:series},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});
}
function buildDatasets(buckets, terms){
  return terms.map((t,i)=>({label:t,data:buckets[t],borderColor:palette(i),backgroundColor:palette(i)+'22',tension:.35,fill:false,borderWidth:2}));
}
function renderAllCharts(items){
  window.__ALL_ITEMS = items;

  // Daily
  const dkw = bucketDailyTerms(items,'keywords',14);
  const dbr = bucketDailyTerms(items,'brands',14);
  const dkwTerms = (DK_SELECTED.length? DK_SELECTED : topTerms(dkw.buckets,8)).filter(t=>dkw.buckets[t]);
  const dbrTerms = (DB_SELECTED.length? DB_SELECTED : topTerms(dbr.buckets,8)).filter(t=>dbr.buckets[t]);

  if(chDKW) chDKW.destroy(); chDKW = drawLine('dailyKeywordsChart', dkw.labels, buildDatasets(dkw.buckets, dkwTerms));
  if(chDBR) chDBR.destroy(); chDBR = drawLine('dailyBrandsChart',   dbr.labels, buildDatasets(dbr.buckets, dbrTerms));

  // Weekly
  const wkw = bucketWeeklyTerms(items,'keywords',12);
  const wbr = bucketWeeklyTerms(items,'brands',12);
  const wkwTerms = (WK_SELECTED.length? WK_SELECTED : topTerms(wkw.buckets,8)).filter(t=>wkw.buckets[t]);
  const wbrTerms = (WB_SELECTED.length? WB_SELECTED : topTerms(wbr.buckets,8)).filter(t=>wbr.buckets[t]);

  if(chWKW) chWKW.destroy(); chWKW = drawLine('weeklyKeywordsChart', wkw.labels, buildDatasets(wkw.buckets, wkwTerms));
  if(chWBR) chWBR.destroy(); chWBR = drawLine('weeklyBrandsChart',   wbr.labels, buildDatasets(wbr.buckets, wbrTerms));

  // Monthly
  const mkw = bucketMonthlyTerms(items,'keywords');
  const mbr = bucketMonthlyTerms(items,'brands');
  const mkwTerms = (MK_SELECTED.length? MK_SELECTED : topTerms(mkw.buckets,8)).filter(t=>mkw.buckets[t]);
  const mbrTerms = (MB_SELECTED.length? MB_SELECTED : topTerms(mbr.buckets,8)).filter(t=>mbr.buckets[t]);

  if(chMKW) chMKW.destroy(); chMKW = drawLine('monthlyKeywordsChart', mkw.labels, buildDatasets(mkw.buckets, mkwTerms));
  if(chMBR) chMBR.destroy(); chMBR = drawLine('monthlyBrandsChart',   mbr.labels, buildDatasets(mbr.buckets, mbrTerms));
}

// ---- Load & render ----
async function load(bust=false){
  document.getElementById('status').textContent='Loadingâ€¦';
  const res=await fetch(DATA_URL+(bust?('?t='+Date.now()):'')); 
  const data=await res.json();
  let items=(data.items||[]).filter(a=>a.published).sort((a,b)=>b.published-a.published);
  items = ensureTags(items);

  renderCards('list-today', items.filter(a=>a.published>=startOfToday()));
  renderCards('list-week',  items.filter(a=>a.published>=startOfWeek()));
  renderCards('list-month', items.filter(a=>a.published>=startOfMonth()));
  renderByDay(items);

  populateSelects(items);
  renderAllCharts(items);

  document.getElementById('status').textContent='Updated '+new Date(data.generatedAt).toLocaleString();
}
document.getElementById('refresh').onclick=()=>load(true);
window.addEventListener('load', ()=>load().catch(e=> document.getElementById('status').textContent='Error: '+e.message));
</script>
</body>
</html>
